---

- name: "openvpn_private_network"
  debug: var=openvpn_private_network
- name: "openvpn_private_addr"
  debug: var=openvpn_private_addr

- name: Install OpenVPN
  apt: pkg=openvpn update_cache=yes state=latest
- name: Install sudo
  apt: pkg=sudo update_cache=yes state=latest

- name: Enable IPv4 forwarding
  sysctl: name="net.ipv4.ip_forward" value=1 state=present sysctl_set=yes reload=yes

- name: Add OpenVPN group
  group: name={{ openvpn_group }} system=yes state=present
- name: Add OpenVPN user
  user: name={{ openvpn_user }} group={{ openvpn_group }} home=/etc/openvpn createhome=false shell=/usr/sbin/nologin system=yes state=present

- name: Make /dev/net
  file: path=/dev/net state=directory owner=root group=root mode=0755
- name: Make /dev/net/tun
  command: mknod /dev/net/tun c 10 200
  args: 
    creates: /dev/net/tun
- name: Make OpenVPN tunnel device
  command: openvpn --mktun --dev {{ openvpn_tun_devname }} --dev-type tun --user {{ openvpn_user }} --group {{ openvpn_group }}
  args:
    creates: /sys/class/net/tun1194

- name: Allow OpenVPN user to "sudo /sbin/ip"
  template: src=openvpn.sudoers.j2 dest=/etc/sudoers.d/openvpn validate='visudo -cf %s'

# TODO: the way this is implemented means Ansible will think the configuration has changed every time I apply. Fix? 
- name: Configure iptables firewall
  template: src=openvpn.iptables.sh.j2 dest=/etc/network/if-pre-up.d/openvpn.iptables.sh owner=root group=root mode=0755
# # - name: Apply iptables firewall configuration
# #   command: /etc/network/if-pre-up.d/openvpn.iptables.sh

- name: Create configuration directory
  file: path=/etc/openvpn state=directory owner={{ openvpn_user }} group={{ openvpn_group }} mode=0755

- name: Upload sudo-ip script
  copy: src=sudo-ip.sh dest=/etc/openvpn/sudo-ip.sh owner={{ openvpn_user }} group={{ openvpn_group }} mode=0755

- name: Upload server configuration
  template: src=server.ovpn.j2 dest=/etc/openvpn/server.ovpn.j2 owner={{ openvpn_user }} group={{ openvpn_group }} mode=0644
  notify:
    - restart-openvpn
